#!/usr/bin/env bash

set -e

echo "åŒæ­¥åŸå§‹æ—¥è®°ä»“åº“"
DAIRY_RAW_DIR="$HOME/diary_post/dairy/"
cd "$DAIRY_RAW_DIR" || { echo "âŒ æ— æ³•è¿›å…¥ç›®å½•ï¼š$DAIRY_RAW_DIR"; exit 1; }
git add .
git commit -m "Update diary: $(date '+%Y-%m-%d %H:%M:%S')" || true
git push

echo "åŠ å¯†æ—¥è®°è‡ªåŠ¨æ›´æ–°å’Œéƒ¨ç½²"

STATUS_LOG=""
WEBSITE_DIR="$HOME/diary_post/dairy_website/"

cd "$WEBSITE_DIR" || { echo "âŒ æ— æ³•è¿›å…¥ç›®å½•ï¼š$WEBSITE_DIR"; exit 1; }

git submodule update --remote --merge

if node scripts/encrypt-diaries.js; then
    echo "âœ… æ—¥è®°åŠ å¯†å®Œæˆ"
    STATUS_LOG="${STATUS_LOG}âœ… æ—¥è®°åŠ å¯†\n"
else
    echo "âŒ åŠ å¯†å¤±è´¥"
    exit 1
fi

if [ -n "$(git status --porcelain)" ]; then
    git add .
    git commit -m "æ›´æ–°åŠ å¯†æ—¥è®° - $(date '+%Y-%m-%d %H:%M:%S')"
    echo "ğŸš€ æ¨é€åˆ° GitHub..."
    git push origin main
    STATUS_LOG="${STATUS_LOG}âœ… æ¨é€åˆ° GitHub\n"
else
    echo "âœ… ç½‘ç«™å†…å®¹å·²æ˜¯æœ€æ–°ï¼Œæ— éœ€æ¨é€"
    STATUS_LOG="${STATUS_LOG}â„¹ï¸ æ— æ–‡ä»¶å˜åŒ–\n"
fi
